ğŸ§  Premessa generale per tutte le operazioni
âSe conosci la soluzione migliore per far funzionare il sistema in modo corretto e coerente, applicala immediatamente senza alcun tipo di rimando: non rimandare, non scrivere log temporanei, non lasciare TODO o scorciatoie, ma implementa subito ciÃ² che sai essere la scelta giusta, perchÃ© la coerenza e la funzionalitÃ  piena vengono prima di tutto. In TouristIQ ogni funzione deve riflettere la versione migliore e completa che puoi offrire, senza pigrizia, senza rinvii, senza approssimazione: fai ora quello che va fatto.â

ğŸ“Œ Contesto dellâ€™azione
Endpoint da sistemare: POST /api/admin/assign-iqcodes

Obiettivo: assegnare un pacchetto IQCode a una struttura, riducendo i codici disponibili dallâ€™admin e registrando lâ€™assegnazione.

âœ… Dati ricevuti nel req.body:
json
Copia
Modifica
{
  "structureId": "stringa_id_struttura",
  "packageSize": 25 // oppure 50, 75, 100
}
ğŸ“¥ 1. Validazione iniziale
Verifica che req.user.role === 'admin'

Verifica che structureId e packageSize siano presenti e validi (packageSize âˆˆ [25, 50, 75, 100])

Altrimenti, rispondi con 400 e messaggio di errore.

ğŸ“Š 2. Recupero dati
Recupera dal DB lâ€™utente admin loggato (req.user.id) â†’ adminAccount

Recupera dal DB la struttura indicata con structureId

Se non trovata, rispondi con 404 â€“ struttura non trovata

ğŸ’¡ 3. Controllo disponibilitÃ  IQCode
Verifica che adminAccount.iqcodes_available >= packageSize

Se non sufficienti, rispondi con 400 â€“ pacchetti non disponibili

ğŸ§¾ 4. Aggiornamento dati
Aggiorna la struttura:

ts
Copia
Modifica
struttura.iqcodes_assigned += packageSize
Aggiorna lâ€™admin:

ts
Copia
Modifica
adminAccount.iqcodes_available -= packageSize
ğŸ“š 5. Storico assegnazione (opzionale ma consigliato)
Registra un log interno:

ts
Copia
Modifica
{
  adminId: ...,
  structureId: ...,
  packageSize: ...,
  date: new Date()
}
ğŸ“¤ 6. Risposta
Status 200 OK

JSON:

json
Copia
Modifica
{
  "success": true,
  "message": "Pacchetto assegnato con successo",
  "data": {
    "structureId": "...",
    "packageSize": 25
  }
}
âš ï¸ Errori comuni da evitare
Non parsare req.body (assicurati che express.json() sia presente a monte)

Dimenticare Authorization nel frontend

Rispondere con HTML invece di JSON â†’ controlla res.status(...).json(...) sempre

ğŸ› ï¸ Extra (opzionale ma utile)
Nel frontend, aggiungi un controllo:

ts
Copia
Modifica
if (response.status === 401) {
  redirectToLogin(); // oppure mostra messaggio "sessione scaduta"
}
Se vuoi, posso generare subito il file completo del controller backend o della funzione frontend per questa API. Fammi sapere cosa vuoi prima: backend o frontend?