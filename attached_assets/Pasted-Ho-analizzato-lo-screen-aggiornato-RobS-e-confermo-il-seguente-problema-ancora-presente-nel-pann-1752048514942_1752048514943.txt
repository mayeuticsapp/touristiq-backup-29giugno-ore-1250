Ho analizzato lo screen aggiornato, RobS, e confermo il seguente problema **ancora presente nel pannello turista**:

> âš ï¸ **"Codici monouso esauriti. Contatta la struttura per una ricarica."**
> âŒ Questo **Ã¨ un messaggio errato**, perchÃ© il turista ha appena attivato un IQCode definitivo e quindi dovrebbe avere **automaticamente 10 codici TIQ-OTC disponibili**.

---

### ğŸ¯ **AZIONI IMMEDIATE DA ESEGUIRE (C24)**

#### âœ… 1. **Controllo Backend â€“ Assegnazione automatica dei 10 TIQ-OTC**

Verifica **se il metodo `generateIQCodeDefinitivo()`** (o metodo analogo) contiene la logica per **inizializzare automaticamente i 10 codici TIQ-OTC.**

* Se **manca**, aggiungere un blocco come:

  ```ts
  await storage.initializeOneTimeCodesForTourist(touristId, 10);
  ```

#### âœ… 2. **Controllo Storage â€“ `getTouristAvailableUses()`**

Controlla che il metodo **restituisca correttamente i codici attivi** dal database.

* Deve filtrare correttamente solo i codici `attivi` (non usati).
* Deve restituire `count > 0` per far apparire i codici come disponibili.

#### âœ… 3. **Controllo Frontend â€“ `OneTimeCodeGenerator.tsx`**

Nel componente frontend:

* Assicurarsi che venga **effettuato il fetch corretto** dopo la creazione dellâ€™IQCode definitivo.
* Aggiungere una **verifica temporanea a mano** tramite bottone "ğŸ”" (refresh) per evitare che il messaggio errato sia causato da cache.

---

### âœ… **Test minimo richiesto (da eseguire ORA)**

1. **Resetta un nuovo utente turistico** (es. IQ-IT-0001-TESTA)
2. Attiva IQCode definitivo dal primo accesso
3. Entra nella dashboard â†’ **deve apparire â€œ10 codici disponibiliâ€**
4. Se ancora non appaiono:

   * Testa lâ€™endpoint API `/api/tourist/one-time-codes` con `curl` per vedere se il backend restituisce i 10 codici
   * Se **sÃ¬** â†’ problema nel frontend
   * Se **no** â†’ problema nel backend/init codici

---

### ğŸ” Alternativa rapida (hotfix temporaneo)

Per non bloccare i test, puoi aggiungere **manualmente** 10 codici TIQ-OTC nel DB a mano per l'utente `IQ-IT-3101-TORRE`, eseguendo:

```sql
INSERT INTO one_time_codes (tourist_id, code, status)
VALUES 
  (3101, '12345', 'attivo'),
  (3101, '23456', 'attivo'),
  ...
  (3101, '67890', 'attivo');
```

ğŸ‘‰ Ma questa Ã¨ solo una toppa. La **logica automatica di inizializzazione va sistemata** definitivamente.

---

Appena C24 conferma il fix o invia i log dellâ€™endpoint `/api/tourist/one-time-codes`, possiamo verificare il corretto funzionamento del sistema. Vuoi che lo solleciti io con messaggio diretto?
