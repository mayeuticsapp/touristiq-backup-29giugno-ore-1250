Chiarissimo RobS. Ecco **le istruzioni definitive e dettagliate** per **C24**.
Questa Ã¨ una **missione chirurgica**: ogni parte del sistema deve cooperare come unâ€™orchestra perfetta.
Nessun frammento lasciato, nessun effetto collaterale trascurato.

---

## ğŸ“œ **ISTRUZIONI PER C24 â€“ IMPLEMENTAZIONE SISTEMA IQCODE MONOUSO TURISTA â†’ PARTNER**

### ğŸ”¹ OBIETTIVO

Consentire al turista di **generare e comunicare un IQCode monouso** (es. a un partner/ristoratore), che puÃ² essere **utilizzato una sola volta**, senza invii nÃ© conferme.
Lâ€™intero flusso deve essere **anonimo, privacy-first, veloce** e **autosufficiente**.

---

## ğŸ§  **1. STRUTTURA DATI**

### âœ… Nuova tabella `one_time_codes` (o integrazione in `iq_codes`)

```sql
- id (UUID)
- code (stringa univoca, es. TIQ-OTC-39572)
- touristId (relazione con utente)
- isUsed (boolean) â€“ default: false
- createdAt
- usedAt (nullable)
```

### âœ… Campo `availableOneTimeUses` in `tourists` (es. default: 10)

```ts
tourist: {
  id: 'uuid',
  name: 'Mario',
  iqCode: 'IQ-IT-...', 
  availableOneTimeUses: 10
}
```

---

## ğŸ”§ **2. FRONTEND â€“ PANNELLO TURISTA**

### ğŸ”¹ Aggiungere sezione: â€œIQCode Monousoâ€

**Posizionamento**: sotto lâ€™IQCode principale.

**Contenuti:**

* Contatore visivo: â€œHai 7 codici monouso disponibiliâ€
* Bottone: `ğŸ” Genera nuovo codice monouso`
* Campo visualizzazione codice (es. TIQ-OTC-32941)
* Bottone `ğŸ“‹ Copia codice`
* (Facoltativo): Tooltip: â€œCondividilo con il partner per ricevere il tuo vantaggioâ€

### ğŸ” Quando lâ€™utente genera un codice:

* `availableOneTimeUses` viene decrementato (-1)
* Viene creata una nuova entry in `one_time_codes`

---

## ğŸ“© **3. BACKEND â€“ API da implementare**

### `POST /api/tourist/generate-one-time-code`

**Richiesta:**

```json
{ "touristId": "uuid" }
```

**Risposta:**

```json
{ "code": "TIQ-OTC-32941", "remaining": 9 }
```

Effetti:

* Crea nuovo codice monouso
* Aggiorna `availableOneTimeUses` (â€“1)

---

### `POST /api/partner/use-one-time-code`

**Richiesta:**

```json
{ "code": "TIQ-OTC-32941" }
```

**Risposta (se valido e non usato):**

```json
{ "valid": true, "used": true }
```

Effetti:

* `isUsed = true`
* `usedAt = now()`
* Nessun legame restituito: lâ€™anonimato resta **intatto**

---

## ğŸ–¥ï¸ **4. FRONTEND â€“ PANNELLO PARTNER**

### âœ… Nuova sezione: â€œValida codice IQ del turistaâ€

* Campo input codice
* Bottone â€œVerificaâ€
* Risposta: â€œâœ… Codice valido, vantaggio attivatoâ€ oppure â€œâŒ Codice non valido o giÃ  usatoâ€

> âš ï¸ **Importante**: Nessun legame nÃ© identificazione del turista visibile nel pannello partner. Solo verifica binaria.

---

## ğŸ“Š **5. VISUALIZZAZIONE & LOGICHE ADMIN**

### Nel pannello admin:

* Aggiungere sezione o colonna: â€œCodici monouso disponibili per ogni turistaâ€
* Se possibile: storico codici generati e usati, ma **non visibile lâ€™IQCode principale del turista**

---

## ğŸ§¹ **6. LOGICA DI SICUREZZA & INTEGRITÃ€**

* Nessun codice puÃ² essere riutilizzato
* Dopo `isUsed = true`, il codice viene bloccato
* Possibile job di cleanup periodico (es. codici non usati da > 60 giorni â†’ eliminati)

---

## ğŸ§ª **7. TEST E CASI LIMITE**

* âœ… Generazione codice da turista con 0 disponibilitÃ  â†’ errore visivo
* âœ… Codice giÃ  usato â†’ messaggio chiaro
* âœ… Codice inesistente â†’ messaggio chiaro
* âœ… Contatore sempre aggiornato nel pannello turista

---

## âœ¨ ESEMPIO FLUSSO COMPLETO

1. **Turista** clicca su â€œGenera codiceâ€ â†’ TIQ-OTC-34958 (rimangono 9)
2. **Turista** comunica il codice al partner (a voce, carta, QR)
3. **Partner** lo inserisce e clicca â€œVerificaâ€
4. **Sistema** risponde: â€œâœ… Codice validoâ€ â†’ `isUsed = true`
5. **Fine.** Nessun dato del turista viene trasmesso. Il codice non Ã¨ piÃ¹ valido.

---

## ğŸ”š **CONCLUSIONE**

Questa soluzione:

* Protegge la privacy al 100%
* Elimina ogni ritorno o rischio di tracciamento
* Semplifica lâ€™esperienza per tutti gli attori

ğŸ§  **C24, applica questa logica in modo perfetto, pulito e coerente.**
Usa nomi consistenti, documenta tutto e assicurati che ogni parte del sistema venga aggiornato.

Fammi sapere appena inizi l'implementazione, cosÃ¬ Geppo tiene tutto sotto controllo.
