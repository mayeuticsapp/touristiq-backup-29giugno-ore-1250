Perfetto RobS, ho letto tutta la sequenza ed Ã¨ chiaro cosa deve essere fatto.

Ecco le istruzioni **completa e definitiva** da inviare a **C24**, in stile operativo, affinchÃ© il sistema TIQ-OTC funzioni **esattamente come da visione**, **senza errori** e con **tutti gli effetti collaterali gestiti correttamente**.

---

### ğŸ“œ **ISTRUZIONI UFFICIALI A C24 â€“ IMPLEMENTAZIONE FINALE SISTEMA TIQ-OTC**

#### âœ… 1. **Inizializzazione Turista con 10 TIQ-OTC**

* Ogni volta che un **nuovo turista** attiva il proprio IQCode definitivo tramite codice primo accesso:

  * Vanno **assegnati automaticamente 10 utilizzi** di TIQ-OTC
  * Questi devono essere **visibili nel pannello turista**
  * Non devono essere richiesti allâ€™amministrazione o caricati manualmente

#### âœ… 2. **Formato Codice**

* Il codice visualizzato deve essere: `TIQ-OTC-12345`
* Il **turista vede sempre il prefisso fisso** â€œTIQ-OTC-â€ sopra il codice
* Il **partner chiede solo le 5 cifre**, che digita nel campo input dedicato

#### âœ… 3. **Struttura dati (DB e storage)**

* Nel database, salvare solo le 5 cifre numeriche (`10000â€“99999`)
* Il sistema backend ricostruisce il prefisso completo `TIQ-OTC-xxxxx` **al momento della validazione**
* In ogni record deve essere salvato:

  * codice numerico
  * data e ora di generazione
  * stato (`attivo`, `usato`)
  * se usato, **nome partner che lo ha convalidato**

#### âœ… 4. **Pannello Turista â€“ UI**

* Il turista vede una lista **storica** dei TIQ-OTC generati e usati:

  * Codici ancora utilizzabili â†’ â€œDisponibiliâ€
  * Codici usati â†’ â€œValidato da: \[Nome Partner]â€
* Deve esserci un **contatore** in alto (es: â€œ3 di 10 utilizzatiâ€)
* Nessun refresh della pagina deve far perdere la visibilitÃ  dei codici

#### âœ… 5. **Pannello Partner â€“ UI**

* Il partner apre la sezione **â€œValida TIQ-OTCâ€** dal menu
* Campo input che accetta **solo 5 cifre**
* Al momento dellâ€™invio:

  * Il sistema aggiunge automaticamente il prefisso `TIQ-OTC-` lato backend
  * Effettua la validazione
  * Mostra conferma visiva: âœ… **Codice valido â€“ Turista autenticato TouristIQ**

#### âœ… 6. **Logica Backend**

* Endpoint `/api/partner/validate-code`:

  * Riceve 5 cifre â†’ aggiunge `TIQ-OTC-` â†’ valida
  * Marca il codice come usato
  * Associa il codice al partner che lo ha convalidato
* Endpoint `/api/tourist/one-time-codes`:

  * Deve restituire i codici con stato e partner associato
  * Deve fornire conteggio esatto dei codici disponibili

#### âœ… 7. **Problema bug â€œ0 crediti disponibiliâ€**

* Verificare **definitivamente** che:

  * Al momento della generazione IQCode definitivo (es. `IQ-IT-2325-PARCO`), vengano **inizializzati correttamente i 10 utilizzi**
  * Lâ€™API `/api/tourist/one-time-codes` recuperi il numero giusto
  * Il **caching frontend** sia disabilitato o sincronizzato correttamente
  * Debug log attivi per confermare i valori in arrivo da storage.ts

#### âœ… 8. **Effetti collaterali da evitare**

* Nessun altro modulo (Admin, Struttura, Partner) deve poter modificare o rigenerare i TIQ-OTC del turista
* Il sistema deve impedire la **duplicazione accidentale** di un codice giÃ  usato
* I TIQ-OTC **scalano solo dopo validazione riuscita**

---

### ğŸ¯ Conclusione

Questo sistema chiude definitivamente la vulnerabilitÃ  **umana** del dettare IQCode. Ãˆ veloce, anonimo, sicuro, e scalabile. La UX Ã¨ naturale, lâ€™identitÃ  TouristIQ Ã¨ mantenuta e lâ€™integrazione Ã¨ fluida.

Procedi ora, C24.
Geppo vigila.
RobS ha deciso.
