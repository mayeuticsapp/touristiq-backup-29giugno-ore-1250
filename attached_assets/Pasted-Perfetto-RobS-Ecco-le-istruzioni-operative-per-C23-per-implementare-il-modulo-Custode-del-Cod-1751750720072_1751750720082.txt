Perfetto RobS.
Ecco **le istruzioni operative per C23** per implementare il modulo **Custode del Codice** nella piattaforma TouristIQ, in piena coerenza con privacy, eleganza narrativa e responsabilitÃ  personale.

---

## ğŸ› ï¸ ISTRUZIONI PER C23

**Funzione: Custode del Codice**
**Scopo**: Permettere al turista di recuperare il proprio codice IQ in caso di smarrimento, senza salvare alcun dato personale, mantenendo privacy e filosofia TouristIQ.

---

### 1. ğŸ”§ DATABASE â€“ Nuova tabella `iqcode_recovery_keys`

```sql
CREATE TABLE iqcode_recovery_keys (
  id SERIAL PRIMARY KEY,
  code TEXT NOT NULL,
  birthdate_hash TEXT NOT NULL,
  keyword_hash TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

* `code`: IQCode associato allâ€™utente
* `birthdate_hash`: hash SHA256 della data di nascita (es. â€œ01/01/1980â€)
* `keyword_hash`: hash SHA256 della parola chiave
* Non devono essere salvati i valori in chiaro

---

### 2. ğŸ§  LOGICA BACKEND

#### âœ… Aggiungere endpoint `POST /api/custode`

> Salva la combinazione codice IQ + hash della data + hash della parola chiave

```ts
router.post('/api/custode', async (req, res) => {
  const { code, birthdate, keyword } = req.body;
  if (!code || !birthdate || !keyword) return res.status(400).json({ message: 'Campi mancanti' });

  const birthdateHash = hash(birthdate);
  const keywordHash = hash(keyword);

  await db.insertInto('iqcode_recovery_keys')
    .values({ code, birthdate_hash: birthdateHash, keyword_hash: keywordHash })
    .execute();

  return res.status(200).json({ message: 'Custode attivato con successo.' });
});
```

---

#### âœ… Aggiungere endpoint `POST /api/recupera-codice`

> Verifica la combinazione e restituisce il codice IQ

```ts
router.post('/api/recupera-codice', async (req, res) => {
  const { birthdate, keyword } = req.body;
  if (!birthdate || !keyword) return res.status(400).json({ message: 'Campi mancanti' });

  const birthdateHash = hash(birthdate);
  const keywordHash = hash(keyword);

  const result = await db.selectFrom('iqcode_recovery_keys')
    .select('code')
    .where('birthdate_hash', '=', birthdateHash)
    .where('keyword_hash', '=', keywordHash)
    .executeTakeFirst();

  if (!result) {
    return res.status(404).json({ message: 'Nessun codice trovato per questi dati.' });
  }

  return res.status(200).json({ code: result.code });
});
```

---

### 3. ğŸ–¥ï¸ FRONTEND

#### âœ… Pannello turista â€“ Sezione â€œCustode del Codiceâ€

* Form di attivazione:

  * Campo 1: â€œInserisci una parola chiave personaleâ€
  * Campo 2: â€œInserisci la tua data di nascita (GG/MM/AAAA)â€
  * Bottone: â€œAttiva il Custodeâ€

ğŸ“¤ POST a `/api/custode`

---

#### âœ… Pagina pubblica â€“ â€œHai perso il tuo codice?â€

* Form:

  * Campo 1: â€œInserisci la tua data di nascitaâ€
  * Campo 2: â€œInserisci la parola chiaveâ€
  * Bottone: â€œRecupera Codice IQâ€

ğŸ“¤ POST a `/api/recupera-codice`

âœ”ï¸ Se trovata combinazione â†’ messaggio con il codice
âŒ Se fallisce â†’ messaggio dâ€™errore generico (â€œNessun codice trovatoâ€)

---

### ğŸ” Sicurezza

* Hash con SHA256 (o equivalente)
* Nessun salvataggio in chiaro di dati
* Codice IQ visibile solo dopo verifica
* Nessun log dellâ€™operazione salvo per auditing anonimo (opzionale)

---

### ğŸ¨ UI/UX suggerita

* Nome sezione: **Custode del Codice**
* Frase descrittiva:

  > â€œProteggi il tuo Codice IQ in caso di smarrimento.
  > Inserisci una parola chiave e la tua data di nascita.
  > Solo tu potrai usarle per recuperarlo.â€

---

Conferma finale e C23 puÃ² eseguire tutto.
Il modulo Ã¨ pronto per essere attivato nel pannello turista.
ğŸ§± TouristIQ si costruisce un mattone alla volta.
